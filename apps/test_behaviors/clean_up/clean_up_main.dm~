diag_mod(clean_up_main,
[
    [
	id ==> is,
	type ==> recursive,
	embedded_dm ==> ask('Please tell me the room to clean up',gpsr2015,true,3,Room,_),
	arcs ==> [
		 success : [apply(initialize_KB,[]),
			    say(['I will search for misplaced objects in the',Room]),
		            apply( consult_kb_value_object_property(R_,P_,V_),[Room,object_path,Obj_Path] )
		           ] => get_misplaced(Obj_Path),
		 error   : [say('I could not recognize the room')] =>fs
		 ]
    ],

    [
	id ==> get_misplaced([]),
	type ==> neutral,
	arcs ==> [
		 empty : [say('No more places to search for objects'),say('The task is finished')] => fs
		 ]
    ],
    
    [
	id ==> get_misplaced(Obj_Path),
	type ==> recursive,
	embedded_dm ==> find(object,X,Obj_Path,[-25.0,25.0],[-30.0,0.0],object,Found,Remaining,false,false,false,_),
	arcs ==> [
		 success : [get(brazo,Arm),
		            assign(Path2,apply( clean_up_f2(O_,RR_),[Obj_Path,Remaining] )),
			    set(obj_path,Path2),
			    Path2 = [Pos|_],
			    get(last_height,RobotHeight),
			    get(last_tilt,Tilt)
		           ] => apply(clean_up_f1(F_,A_,R_,RH_,T_,P_),[Found,Arm,Remaining,RobotHeight,Tilt,Pos]), 
		 error   : [say('I could not find any object')] => fs
		 ]
    ],

    [
	id ==> get_obj(Object,1),
	type ==> recursive,
	embedded_dm ==> take(Object, right, _, _),
	arcs ==> [
		 success : [robotheight(1.20),
                            set(last_height,1.20),
                            set(brazo,2),
                            get(obj_path,Obj_P)
			   ] => get_misplaced(Obj_P),
		 error   : [robotheight(1.20),
                            set(last_height,1.20),
                            advance_fine(-0.20, _),
                            get(obj_path,Obj_P)
			   ] => get_misplaced(Obj_P)
	         ] 
    ],

    [
	id ==> get_obj(Object,2),
	type ==> recursive,
	embedded_dm ==> take(Object, left, _, _),
	arcs ==> [
		 success : [set(brazo,1)] => deliver,
		 error   : [set(brazo,1)] => deliver
    	         ]
    ],


    [
	id ==> deliver,
	type ==> recursive,
	embedded_dm ==> deliver_clean_up,
	arcs ==> [
		 success : [get(obj_path,Obj_P)] => get_misplaced(Obj_P),
		 error   : empty => fs
		 ]
    ],


    [
	id ==> fs,
	type ==> final
    ]
],
[
    obj_path ==> [],
    brazo ==> 1
]
).
